<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DLP Audit Parser - Pro Analytics Fixed Final</title>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root {
        --bg: #0f172a;
        --card-bg: #1e293b;
        --text-main: #f8fafc;
        --text-dim: #94a3b8;
        --accent: #10b981;
        --primary: #38bdf8;
        --danger: #ef4444;
        --border: #334155;
    }

    body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text-main); }
    
    .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .control-panel { background: var(--card-bg); padding: 12px; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }

    .summary-stats { display: flex; gap: 20px; margin-bottom: 25px; }
    .stat-box { background: var(--card-bg); border: 1px solid var(--border); padding: 20px; border-radius: 16px; flex: 1; }
    .stat-value { font-size: 32px; font-weight: 800; color: var(--accent); margin-top: 5px; }

    /* TABLE CONTAINER - PENTING: overflow: visible agar dropdown tidak terpotong */
    .table-section { 
        background: var(--card-bg); 
        border-radius: 12px; 
        border: 1px solid var(--border); 
        max-height: 500px; 
        overflow-x: auto; 
        overflow-y: auto;
        margin-bottom: 25px;
        position: relative;
    }

    table { border-collapse: separate; border-spacing: 0; width: 100%; min-width: 1500px; table-layout: fixed; }
    
    /* HEADER STICKY */
    th { 
        background: #1e293b; 
        color: var(--text-dim); 
        position: sticky; 
        top: 0; 
        z-index: 100; /* Header tetap di atas */
        padding: 12px; 
        font-size: 11px; 
        text-transform: uppercase; 
        border-bottom: 2px solid var(--border); 
        text-align: left;
        overflow: visible; /* Izinkan dropdown keluar dari TH */
    }

    td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    tr:hover { background: #334155; }
    
    /* FILTER DROPDOWN SYSTEM */
    .header-filter-container { position: relative; width: 100%; overflow: visible; }
    
    .search-box { 
        width: 100%; padding: 6px 10px; border-radius: 6px; background: #0f172a; 
        border: 1px solid var(--border); color: white; font-size: 11px; margin-bottom: 5px; box-sizing: border-box;
    }

    .filter-btn { 
        background: #334155; color: var(--text-main); cursor: pointer; padding: 6px; 
        font-size: 10px; border-radius: 4px; text-align: center; border: 1px solid var(--border); width: 100%;
    }

    .selected-count {
        display: block; font-size: 10px; color: var(--accent); margin-top: 4px; font-weight: bold;
    }

    /* DROPDOWN - Sekarang kembali ke Absolute agar menempel pada Header saat scroll */
    .dropdown { 
        position: absolute; 
        background: #1e293b; 
        border: 2px solid var(--primary); 
        z-index: 9999; 
        max-height: 250px; 
        overflow-y: auto; 
        width: 260px; 
        display: none; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.8); 
        border-radius: 8px; 
        padding: 8px;
        top: 100%; 
        left: 0;
        margin-top: 5px;
    }

    .filter-item { 
        padding: 8px 10px; 
        display: flex; 
        align-items: center; 
        gap: 12px; 
        border-radius: 6px; 
        color: var(--text-main);
        border-bottom: 1px solid var(--border);
    }
    .filter-item:hover { background: #334155; cursor: pointer; }
    .filter-item input { width: 16px; height: 16px; cursor: pointer; }

    /* Layout Charts */
    .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .chart-card { background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid var(--border); }
    .top-list li { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #0f172a; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid var(--primary); }
    .badge { background: var(--primary); color: #000; padding: 2px 10px; border-radius: 20px; font-weight: bold; }
    .reset-btn { background: var(--danger); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; }
</style>
</head>
<body>

<div class="header-area">
    <h1><span style="color:var(--accent)">●</span> DLP Audit Parser Pro</h1>
    <div class="control-panel">
        <input type="file" id="csvFile" accept=".csv">
        <button class="reset-btn" onclick="location.reload()">Reset All</button>
    </div>
</div>

<div class="summary-stats">
    <div class="stat-box"><p>Total Records</p><h3 id="statTotal" class="stat-value">0</h3></div>
    <div class="stat-box"><p>Unique Users</p><h3 id="statUsers" class="stat-value">0</h3></div>
</div>

<div class="table-section">
    <table id="mainTable">
        <thead>
            <tr>
                <th style="width:160px">Operation</th>
                <th style="width:120px">Workload</th>
                <th style="width:220px">User</th>
                <th style="width:300px">Filename</th>
                <th style="width:80px">Ext</th>
                <th style="width:100px">Size (MB)</th>
                <th style="width:120px">Date</th>
                <th>Object ID</th>
            </tr>
            <tr id="filterRow"></tr>
        </thead>
        <tbody id="tableBody">
            <tr><td colspan="8" style="text-align:center; padding: 50px; color: var(--text-dim);">Awaiting data...</td></tr>
        </tbody>
    </table>
</div>

<div class="dashboard-grid">
    <div class="chart-card"><h3>Operation Distribution</h3><div style="height: 250px;"><canvas id="chartOp"></canvas></div></div>
    <div class="chart-card"><h3>Top 5 Users</h3><div style="height: 250px;"><canvas id="chartUser"></canvas></div></div>
</div>

<script>
let rawData = [];
let charts = {};

// Tutup dropdown jika klik di luar
document.addEventListener("click", e => {
    if (!e.target.closest('.header-filter-container')) {
        document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
    }
});

document.getElementById('csvFile').onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            rawData = results.data.map(transformData).filter(r => r);
            initFilters();
            runFilter();
        }
    });
};

function transformData(row) {
    try {
        const audit = JSON.parse(row.AuditData || "{}");
        const rawSize = audit.FileSizeBytes || audit.FileSize || 0;
        return {
            operation: row.Operation || audit.Operation || "Unknown",
            workload: audit.Workload || row.Workload || "N/A",
            user: row.UserId || audit.UserId || "Unknown",
            filename: audit.SourceFileName || (audit.ObjectId || "").split('/').pop() || "N/A",
            extension: audit.SourceFileExtension || audit.FileExtension || "",
            sizeMB: parseFloat((rawSize / (1024 * 1024)).toFixed(2)) || 0,
            date: (audit.CreationTime || row.CreationDate || "").split('T')[0] || "N/A",
            objectId: audit.ObjectId || audit.TargetFilePath || ""
        };
    } catch (e) { return null; }
}

function initFilters() {
    const filterRow = document.getElementById('filterRow');
    filterRow.innerHTML = '';
    const cols = ['operation', 'workload', 'user', 'filename', 'extension', 'sizeMB', 'date', 'objectId'];
    
    cols.forEach(col => {
        const th = document.createElement('th');
        const uniqueVals = [...new Set(rawData.map(d => String(d[col])))].filter(v => v && v !== "0").sort();
        
        th.innerHTML = `
            <div class="header-filter-container">
                <input type="text" class="search-box" placeholder="Search..." id="search-${col}">
                <button class="filter-btn" onclick="toggleDD(event, '${col}')">FILTER ▼</button>
                <span class="selected-count" id="count-${col}"></span>
                <div class="dropdown" id="dd-${col}">
                    ${uniqueVals.map(v => `
                        <div class="filter-item" onclick="handleCheck(event)">
                            <input type="checkbox" value="${v}" onchange="updateFilterUI('${col}')">
                            <span>${v}</span>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        filterRow.appendChild(th);
        th.querySelector('input').oninput = runFilter;
    });
}

function toggleDD(e, col) {
    e.stopPropagation();
    const dd = document.getElementById(`dd-${col}`);
    const isOpen = dd.style.display === 'block';
    document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
    dd.style.display = isOpen ? 'none' : 'block';
}

function handleCheck(e) {
    if (e.target.tagName !== 'INPUT') {
        const cb = e.currentTarget.querySelector('input');
        cb.checked = !cb.checked;
        cb.dispatchEvent(new Event('change'));
    }
}

// Menangani tampilan jumlah dipilih dan memicu filter data
function updateFilterUI(col) {
    const checked = document.querySelectorAll(`#dd-${col} input:checked`);
    const countSpan = document.getElementById(`count-${col}`);
    countSpan.innerText = checked.length > 0 ? `Selected: ${checked.length}` : "";
    runFilter();
}

function runFilter() {
    const cols = ['operation', 'workload', 'user', 'filename', 'extension', 'sizeMB', 'date', 'objectId'];
    const filtered = rawData.filter(row => {
        return cols.every(col => {
            const searchVal = document.getElementById(`search-${col}`).value.toLowerCase();
            const checked = Array.from(document.querySelectorAll(`#dd-${col} input:checked`)).map(i => i.value);
            const val = String(row[col]).toLowerCase();
            return val.includes(searchVal) && (checked.length === 0 || checked.includes(String(row[col])));
        });
    });
    renderTable(filtered);
    updateDashboard(filtered);
}

function renderTable(data) {
    const body = document.getElementById('tableBody');
    const limit = data.slice(0, 100);
    body.innerHTML = limit.map(r => `
        <tr>
            <td style="color:var(--primary); font-weight:600">${r.operation}</td>
            <td>${r.workload}</td>
            <td>${r.user}</td>
            <td>${r.filename}</td>
            <td>${r.extension}</td>
            <td style="color:var(--accent)">${r.sizeMB || ''}</td>
            <td>${r.date}</td>
            <td style="color:var(--text-dim); font-size:11px">${r.objectId}</td>
        </tr>`).join('');
}

function updateDashboard(data) {
    document.getElementById('statTotal').innerText = data.length.toLocaleString();
    document.getElementById('statUsers').innerText = [...new Set(data.map(d => d.user))].length;

    const opCounts = countOcc(data, 'operation');
    refreshChart('op', document.getElementById('chartOp'), 'doughnut', opCounts);

    const userCounts = countOcc(data, 'user', 5);
    refreshChart('user', document.getElementById('chartUser'), 'bar', userCounts);
}

function countOcc(data, key, limit) {
    const counts = {};
    data.forEach(d => counts[d[key]] = (counts[d[key]] || 0) + 1);
    const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
    return Object.fromEntries(limit ? sorted.slice(0, limit) : sorted);
}

function refreshChart(id, canvas, type, dataObj) {
    if (charts[id]) charts[id].destroy();
    charts[id] = new Chart(canvas, {
        type: type,
        data: {
            labels: Object.keys(dataObj),
            datasets: [{
                data: Object.values(dataObj),
                backgroundColor: ['#38bdf8', '#10b981', '#fbbf24', '#ef4444', '#a855f7'],
                borderColor: '#1e293b', borderWidth: 2
            }]
        },
        options: { 
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: type === 'doughnut', position: 'right', labels: { color: '#94a3b8' } } },
            scales: type === 'bar' ? { 
                y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                x: { ticks: { color: '#94a3b8' } } 
            } : {}
        }
    });
}
</script>
</body>
</html>


ini harus ada koneksi internet? kalo gak ada gimana
